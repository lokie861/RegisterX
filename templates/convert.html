{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='fontawesome/css/all.min.css') }}">
<h2><i class="fas fa-exchange-alt"></i> PLC Register to Modbus Converter</h2>

<div class="converter-wrapper">
  <!-- Input Form -->
  <div class="converter-input">
    <form id="convertForm">
      <label for="plc_make"><i class="fa-brands fa-bandcamp"></i> PLC Make:</label>
        <select name="plc_make" id="plc_make" required>
          {% for make in plc_make %}
            <option value="{{ make }}">{{ make }}</option>
          {% endfor %}
        </select>

        <label for="plc"><i class="fas fa-microchip"></i> PLC Type:</label>
        <select name="plc" id="plc" required></select>

      <label for="reg_type"><i class="fas fa-cube"></i> Address Type:</label>
      <select name="reg_type" id="reg_type" required>
        <option value="bit">Bit</option>
        <option value="word">Word</option>
      </select>
      <label for="address"><i class="fas fa-keyboard"></i> Register Address:</label>
      <input type="text" id="address" name="address" placeholder="e.g. M2401" required>

      <button type="submit"><i class="fas fa-calculator"></i> Convert</button>
    </form>
  </div>

  <!-- Results -->
  <div class="converter-output">
    <div class="result">
      <h3><i class="fas fa-list-alt"></i> Results</h3>
      <p><strong>Raw Modbus Address:</strong> <span id="raw">-</span>
        <button class="copy-btn" onclick="copyToClipboard('raw')"><i class="fas fa-copy"></i></button>
      </p>
      <p><strong>Converted Value:</strong> <span id="converted">-</span>
        <button class="copy-btn" onclick="copyToClipboard('converted')"><i class="fas fa-copy"></i></button>
      </p>
    </div>
  </div>
</div>

<script>
  // Populate PLC Types dynamically
  const plcMappings = {{ plc_mappings | tojson }};
  const plcMakeSelect = document.getElementById("plc_make");
  const plcTypeSelect = document.getElementById("plc");

  function populatePLCTypes() {
    const selectedMake = plcMakeSelect.value;
    const types = plcMappings[selectedMake] || [];
    plcTypeSelect.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "-- Select PLC Type --";
    placeholder.disabled = true;
    placeholder.selected = true;
    plcTypeSelect.appendChild(placeholder);
    types.forEach(type => {
      const option = document.createElement("option");
      option.value = type;
      option.textContent = type;
      plcTypeSelect.appendChild(option);
    });
  }
  plcMakeSelect.addEventListener("change", populatePLCTypes);
  populatePLCTypes();

  // Form submission
  document.getElementById("convertForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const plc = plcTypeSelect.value;
    const address = document.getElementById("address").value;
    const reg_type = document.getElementById("reg_type").value;

    fetch(`api/convert?plc=${encodeURIComponent(plc)}&address=${encodeURIComponent(address)}&regtype=${encodeURIComponent(reg_type)}`)
      .then(resp => resp.json())
      .then(data => {
        document.getElementById("raw").innerText = data.raw;
        document.getElementById("converted").innerText = data.converted;
      })
      .catch(err => {
        document.getElementById("raw").innerText = "-";
        document.getElementById("converted").innerText = "Error: " + err;
      });
  });

  // Clipboard copy
  function copyToClipboard(elementId) {
    const text = document.getElementById(elementId).innerText;
    navigator.clipboard.writeText(text).then(() => {
      alert("Copied!");
    }).catch(err => alert("Failed: "+err));
  }
</script>

{% endblock %}
